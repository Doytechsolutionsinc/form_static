<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrotex AI Trainer</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Metrotex Knowledge Trainer</h1>
            <p class="subtitle">Teach your AI with multiple question/answer variations</p>
        </header>
        
        <div id="status" class="status"></div>
        
        <form id="training-form">
            <div class="form-section">
                <h2><span class="icon">‚ùì</span> Questions</h2>
                <div id="questions-container">
                    <div class="input-group">
                        <input type="text" class="question-input" placeholder="Main question" required>
                        <button type="button" class="btn-remove" onclick="removeField(this)">√ó</button>
                    </div>
                </div>
                <button type="button" class="btn-add" onclick="addField('question')">
                    + Add Question Variation
                </button>
            </div>
            
            <div class="form-section">
                <h2><span class="icon">üí°</span> Answers</h2>
                <div id="answers-container">
                    <div class="input-group">
                        <textarea class="answer-input" placeholder="Main answer" required></textarea>
                        <button type="button" class="btn-remove" onclick="removeField(this)">√ó</button>
                    </div>
                </div>
                <button type="button" class="btn-add" onclick="addField('answer')">
                    + Add Answer Variation
                </button>
            </div>
            
            <button type="submit" class="btn-submit">
                <span class="btn-text">üöÄ Train All Variations</span>
                <span class="btn-loader">‚è≥ Training...</span>
            </button>
        </form>
        
        <div class="recent-entries">
            <h2><span class="icon">üïí</span> Recently Added</h2>
            <div id="entries-list">
                <p>No entries yet. Start training above!</p>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const statusEl = document.getElementById('status');
        const form = document.getElementById('training-form');
        
        // Add new input field
        function addField(type) {
            const container = document.getElementById(`${type}s-container`);
            const newGroup = document.createElement('div');
            newGroup.className = 'input-group';
            
            if (type === 'question') {
                newGroup.innerHTML = `
                    <input type="text" class="question-input" placeholder="Alternative phrasing">
                    <button type="button" class="btn-remove" onclick="removeField(this)">√ó</button>
                `;
            } else {
                newGroup.innerHTML = `
                    <textarea class="answer-input" placeholder="Alternative answer"></textarea>
                    <button type="button" class="btn-remove" onclick="removeField(this)">√ó</button>
                `;
            }
            
            container.appendChild(newGroup);
        }
        
        // Remove field
        function removeField(btn) {
            const groups = document.querySelectorAll('.input-group');
            if (groups.length > 1) {
                btn.parentElement.remove();
            } else {
                showStatus('You need at least one question and answer', 'error');
            }
        }
        
        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);
            
            // Collect all questions and answers
            const questions = Array.from(document.querySelectorAll('.question-input'))
                .map(el => el.value.trim())
                .filter(q => q);
                
            const answers = Array.from(document.querySelectorAll('.answer-input'))
                .map(el => el.value.trim())
                .filter(a => a);
            
            // Validate
            if (questions.length === 0 || answers.length === 0) {
                showStatus('Please add at least one question and answer', 'error');
                setLoading(false);
                return;
            }
            
            try {
                // Send to backend
                const response = await fetch('/train', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ questions, answers })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showStatus(
                        `‚úÖ Success! Trained ${questions.length} question(s) with ${answers.length} answer(s)`,
                        'success'
                    );
                    // Reset form but keep first fields
                    document.querySelectorAll('.input-group').forEach((el, i) => {
                        if (i > 0) el.remove();
                    });
                    document.querySelector('.question-input').value = '';
                    document.querySelector('.answer-input').value = '';
                    loadRecentEntries();
                } else {
                    throw new Error(result.error || 'Training failed');
                }
            } catch (err) {
                showStatus(`‚ùå Error: ${err.message}`, 'error');
                console.error('Training error:', err);
            } finally {
                setLoading(false);
            }
        });
        
        // Load recent entries
        async function loadRecentEntries() {
            try {
                const response = await fetch('/recent-entries');
                const entries = await response.json();
                
                const entriesList = document.getElementById('entries-list');
                if (!entries.length) {
                    entriesList.innerHTML = '<p>No entries yet</p>';
                    return;
                }
                
                entriesList.innerHTML = entries.map(entry => `
                    <div class="entry">
                        <div class="entry-question">${escapeHtml(entry.question)}</div>
                        <div class="entry-answer">${escapeHtml(entry.answer)}</div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load entries:', err);
            }
        }
        
        // Helper functions
        function setLoading(isLoading) {
            const btn = document.querySelector('.btn-submit');
            btn.disabled = isLoading;
            document.querySelector('.btn-text').style.display = 
                isLoading ? 'none' : 'inline';
            document.querySelector('.btn-loader').style.display = 
                isLoading ? 'inline' : 'none';
        }
        
        function showStatus(message, type) {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            setTimeout(() => {
                statusEl.textContent = '';
                statusEl.className = 'status';
            }, 5000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initial load
        loadRecentEntries();
    </script>
</body>
    </html>
